{#
requirement_analysis.jinja2

Stage 1: Problem-Agnostic Requirement Entity Analysis

This template guides LLM to extract entities, data requirements, and analysis needs
from a research requirement, considering context from previously confirmed answers.

INPUT VARIABLES:
- requirement: Dict with requirement_id, title, description, expected_deliverables
- context: Dict[requirement_id, RequirementAnswer] - confirmed answers from dependencies
- research_goal: ResearchGoal - global context (fallback only)
#}

You are an expert biomedical research analyst specializing in entity extraction and research planning.

**IMPORTANT: ALL output MUST be in English.**

Your task is to analyze a research requirement and extract:
1. **Primary Entities** - biological/chemical entities mentioned in the requirement
2. **Data Requirements** - what data sources are needed
3. **Analysis Needs** - what computational analyses are required
4. **Context Refinements** - how previous answers refine this requirement

================================================================================
REQUIREMENT TO ANALYZE
================================================================================

**Requirement ID**: {{ requirement.requirement_id }}
**Title**: {{ requirement.title }}

**Description**:
{{ requirement.description }}

{% if requirement.expected_deliverables %}
**Expected Deliverables**:
{% for deliverable in requirement.expected_deliverables %}
- {{ deliverable }}
{% endfor %}
{% endif %}

{% if context %}
================================================================================
CONTEXT FROM DEPENDENCY REQUIREMENTS
================================================================================

The following requirements have been completed and their answers provide context
for the current requirement. Extract refinements from their deliverables.

{% for dep_id, dep_answer in context.items() %}
---
**Dependency {{ dep_id }}**:
{{ dep_answer.answer|truncate(300) }}

**Deliverables**:
{{ dep_answer.deliverables|tojson(indent=2) }}

{% endfor %}
{% endif %}

{% if research_goal %}
================================================================================
GLOBAL RESEARCH GOAL (FALLBACK CONTEXT ONLY)
================================================================================

{{ research_goal.description }}

**NOTE**: Use this only as general context. Focus on the requirement and context above.
{% endif %}

================================================================================
ENTITY TYPES REFERENCE
================================================================================

Identify entities in the requirement description and context. Support these types:

| Entity Type | Indicators | Example Databases | Examples |
|-------------|------------|-------------------|----------|
| **protein** | protein, receptor, enzyme, antibody, kinase | UniProt, PDB | TNFR1, ACE2, Spike protein, IL-6R |
| **gene** | gene, allele, mutation, expression, transcript | NCBI Gene, KEGG | BRCA1, TP53, EGFR, MYC |
| **pathway** | pathway, signaling, cascade, network | KEGG Pathway, Reactome | MAPK signaling, Glycolysis, Apoptosis |
| **compound** | compound, drug, molecule, ligand, inhibitor | KEGG Compound, PubChem | Aspirin, ATP, Glucose, Metformin |
| **disease** | disease, disorder, syndrome, condition | KEGG Disease, NCBI | Alzheimer's, Cancer, Diabetes, COVID-19 |
| **domain** | domain, region, motif, site, residue | UniProt, PDB | CRD2-CRD3, RBD, kinase domain, binding site |
| **organism** | species, strain, cell line, tissue | NCBI Taxonomy, KEGG | Homo sapiens, E. coli, HeLa cells, liver tissue |
| **assay** | assay, experiment, measurement, readout | ChEMBL, PubChem BioAssay | IC50, binding affinity, cell viability |

**Classification Guidelines**:
- An entity can have multiple types (e.g., "BRCA1 gene" is both gene and protein)
- Prioritize the type most relevant to the requirement
- Extract both broad entities (TNFR1) and specific regions (CRD2-CRD3)
- Use context deliverables to identify refined entities

================================================================================
TOOL SELECTION REFERENCE
================================================================================

Use this reference to generate `tool_guidance` based on entity types and analysis needs:

## Data Collection Tools (by entity type)

| Entity Type | Primary Tools | Use When |
|-------------|---------------|----------|
| **protein** | uniprot.get_protein_info, rcsbpdb.download_pdb | Need sequence, structure, annotations |
| **gene** | ncbi.get_gene_info, kegg.get_gene_info | Need gene details, expression, orthologs |
| **pathway** | kegg.get_pathway_info, gprofiler.enrichment_analysis | Need pathway components, enrichment |
| **compound** | kegg.get_compound_info, chembl.get_compound_activities | Need drug data, bioactivities |
| **disease** | kegg.get_disease_info, opentargets.get_disease_associations | Need disease-gene/pathway links |
| **domain** | interpro.analyze_domains, interpro.get_domain_architecture | Need domain structure, boundaries |
| **interaction** | stringdb.get_protein_network, stringdb.get_interaction_partners | Need PPI data, interactors |

## Analysis Tools (by analysis need)

| Analysis Need | Primary Tools | Secondary Tools |
|---------------|---------------|-----------------|
| **network_analysis** | networkx.build_network, networkx.find_hub_proteins | stringdb.get_enrichment_analysis |
| **pathway_enrichment** | gprofiler.enrichment_analysis, kegg.get_pathway_info | stringdb.get_enrichment_analysis |
| **structure_prediction** | esmfold.predict_structure, colabfold.predict_structure | rcsbpdb.download_pdb (if known) |
| **binder_design** | rfdiffusion.design_binder, proteinmpnn.design_sequence | colabfold.predict_binder_complex |
| **docking** | vina.dock_ligand, rosetta.dock_proteins | rcsbpdb.get_binding_sites |
| **immunogenicity** | iedb.scan_protein, iedb.predict_mhc_binding | N/A |
| **druggability** | opentargets.assess_druggability, chembl.get_bioactivities | opentargets.search_target_drugs |
| **homology_search** | blast.find_similar_proteins, foldseek.search_structure | msa.align_sequences |
| **conservation** | msa.align_sequences, msa.calculate_conservation | blast.find_similar_proteins |

## Tool Selection Guidelines

1. **Match entity type** → Select collection tools from the entity type table
2. **Match analysis need** → Select analysis tools from the analysis need table
3. **Consider data flow**:
   - STRING data → can feed into NetworkX
   - PDB structure → required for Rosetta/Vina docking
   - Sequence → required for ESMFold/BLAST/MSA
   - Binder backbone (RFdiffusion) → needs ProteinMPNN for sequence design
4. **GPU requirements**:
   - ColabFold (24GB+), RFdiffusion (16GB+), ProteinMPNN (8GB+) require GPU
   - Consider ESMFold as CPU alternative for structure prediction

================================================================================
EXTRACTION GUIDELINES
================================================================================

## 1. PRIMARY ENTITIES

Extract all biological/chemical entities mentioned in:
- Requirement description (PRIMARY SOURCE)
- Context deliverables (REFINEMENT SOURCE)
- Research goal (FALLBACK)

For each entity, provide:
- **type**: One of the entity types above
- **name**: The entity name/identifier
- **description**: Brief description of the entity's role in this requirement
- **identifiers**: Known IDs (e.g., UniProt ID, KEGG ID, PDB ID) if mentioned
- **source**: "requirement" or "context" or "research_goal"
- **priority**: "required" (must have) | "recommended" (should have) | "optional" (nice to have)

**Example**:
```json
{
  "type": "protein",
  "name": "TNFR1",
  "description": "Target protein for mini-binder design",
  "identifiers": {"uniprot": "P19438"},
  "source": "requirement",
  "priority": "required"
}
```

## 2. DATA REQUIREMENTS

Based on entities and expected deliverables, determine what data is needed.

For each data requirement, provide:
- **type**: "sequence" | "structure" | "pathway" | "interaction" | "literature" | "expression" | "variant" | "binding_affinity" | "mutation_effect" | "taxonomy"
- **source**: Preferred database (e.g., "uniprot", "pdb", "kegg", "ncbi", "pubmed", "chembl", "clinvar")
- **priority**: "required" | "recommended" | "optional"
- **reason**: Brief explanation of why this data is needed

**Example**:
```json
{
  "type": "structure",
  "source": "pdb",
  "priority": "required",
  "reason": "Need 3D structure of TNFR1 for binding site analysis"
}
```

## 3. ANALYSIS NEEDS

Based on the requirement and expected deliverables, identify computational analyses needed.

Common analysis types:
- **binding_energy**: Calculate interaction energy (Rosetta)
- **docking**: Protein-protein or protein-ligand docking (Rosetta, AutoDock)
- **structure_prediction**: Predict 3D structure (ESMFold, AlphaFold)
- **homology_search**: Find similar sequences (BLAST)
- **conservation_analysis**: Analyze evolutionary conservation
- **pathway_enrichment**: Identify enriched pathways (KEGG)
- **visualization**: Visualize structures or pathways (PyMOL)

Return as list of strings: `["binding_energy", "docking", ...]`

## 4. CONTEXT REFINEMENTS

Extract specific refinements from context deliverables that focus the current requirement.

**Examples**:
- Context deliverable: `{"binding_site": "CRD2-CRD3", "critical_residues": ["R31", "K35"]}`
  → Refinement: Focus data collection on CRD2-CRD3 domain, not entire protein

- Context deliverable: `{"pathway": "MAPK/ERK", "key_proteins": ["MEK1", "ERK2"]}`
  → Refinement: Prioritize MEK1 and ERK2 in pathway analysis

Return as dict mapping refinement keys to values:
```json
{
  "binding_site": "CRD2-CRD3",
  "critical_residues": ["R31", "K35", "D43"],
  "focus_region": "amino acids 30-50"
}
```

================================================================================
OUTPUT FORMAT (STRICT JSON)
================================================================================

Return ONLY valid JSON in this exact format:

```json
{
  "primary_entities": [
    {
      "type": "protein|gene|pathway|compound|disease|domain",
      "name": "Entity name",
      "description": "Brief description of role in this requirement",
      "identifiers": {
        "database_name": "identifier"
      },
      "source": "requirement|context|research_goal",
      "priority": "required|recommended|optional"
    }
  ],
  "data_requirements": [
    {
      "type": "sequence|structure|pathway|interaction|literature|expression|variant",
      "source": "uniprot|pdb|kegg|ncbi|pubmed|reactome|...",
      "priority": "required|recommended|optional",
      "reason": "Why this data is needed"
    }
  ],
  "analysis_needs": [
    "binding_energy",
    "docking",
    "structure_prediction",
    "..."
  ],
  "context_refinements": {
    "refinement_key": "refinement_value",
    "...": "..."
  },
  "tool_guidance": {
    "collection_tools": [
      {
        "server": "server_name",
        "tool": "tool_name",
        "purpose": "Brief description of why this tool is needed",
        "for_entity": "entity_name"
      }
    ],
    "analysis_tools": [
      {
        "server": "server_name",
        "tool": "tool_name",
        "purpose": "Brief description of why this tool is needed"
      }
    ]
  }
}
```

================================================================================
EXAMPLE OUTPUTS
================================================================================

**NOTE**: The examples below illustrate the OUTPUT FORMAT and STRUCTURE only.
The specific entities (TNFR1, MAPK, ACE2, etc.) are just examples - apply the same
pattern to whatever entities appear in YOUR actual requirement.

**Example 1: Protein Design (with context)**

Requirement: "Design mini-protein binder targeting TNFR1 CRD2-CRD3 domain"
Context: {"1": {"deliverables": {"binding_site": "CRD2-CRD3", "critical_residues": ["R31", "K35"]}}}

Output:
```json
{
  "primary_entities": [
    {
      "type": "protein",
      "name": "TNFR1",
      "description": "Target protein for mini-binder design",
      "identifiers": {"uniprot": "P19438"},
      "source": "requirement",
      "priority": "required"
    },
    {
      "type": "domain",
      "name": "CRD2-CRD3",
      "description": "Specific binding domain on TNFR1",
      "identifiers": {},
      "source": "context",
      "priority": "required"
    }
  ],
  "data_requirements": [
    {
      "type": "structure",
      "source": "pdb",
      "priority": "required",
      "reason": "Need TNFR1 3D structure for CRD2-CRD3 domain analysis"
    },
    {
      "type": "sequence",
      "source": "uniprot",
      "priority": "required",
      "reason": "Need TNFR1 sequence to identify CRD2-CRD3 residues"
    }
  ],
  "analysis_needs": ["binder_design", "structure_prediction", "docking"],
  "context_refinements": {
    "binding_site": "CRD2-CRD3",
    "critical_residues": ["R31", "K35"]
  },
  "tool_guidance": {
    "collection_tools": [
      {"server": "uniprot", "tool": "get_protein_info", "purpose": "Get TNFR1 sequence and annotations", "for_entity": "TNFR1"},
      {"server": "rcsbpdb", "tool": "download_pdb", "purpose": "Get TNFR1 3D structure for binder design", "for_entity": "TNFR1"},
      {"server": "interpro", "tool": "get_domain_architecture", "purpose": "Identify CRD2-CRD3 domain boundaries", "for_entity": "CRD2-CRD3"}
    ],
    "analysis_tools": [
      {"server": "rfdiffusion", "tool": "design_binder", "purpose": "Generate binder backbone targeting CRD2-CRD3"},
      {"server": "proteinmpnn", "tool": "design_sequence", "purpose": "Design sequence for binder backbone"},
      {"server": "colabfold", "tool": "predict_binder_complex", "purpose": "Validate binder-target complex structure"}
    ]
  }
}
```

**Example 2: Pathway/Network Analysis (IL-11 Inhibitor Discovery)**

Requirement: "Identify IL-11 pathway interactors and potential inhibitor targets"

Output:
```json
{
  "primary_entities": [
    {
      "type": "protein",
      "name": "IL-11",
      "description": "Target cytokine for inhibitor discovery",
      "identifiers": {"uniprot": "P20809"},
      "source": "requirement",
      "priority": "required"
    },
    {
      "type": "pathway",
      "name": "IL-11/JAK-STAT signaling",
      "description": "Signaling pathway to analyze for drug targets",
      "identifiers": {"kegg": "hsa04630"},
      "source": "requirement",
      "priority": "required"
    }
  ],
  "data_requirements": [
    {
      "type": "interaction",
      "source": "stringdb",
      "priority": "required",
      "reason": "Need IL-11 protein-protein interaction network"
    },
    {
      "type": "pathway",
      "source": "kegg",
      "priority": "required",
      "reason": "Need JAK-STAT pathway components and hierarchy"
    }
  ],
  "analysis_needs": ["network_analysis", "pathway_enrichment", "druggability"],
  "context_refinements": {},
  "tool_guidance": {
    "collection_tools": [
      {"server": "stringdb", "tool": "get_protein_network", "purpose": "Get IL-11 interaction network", "for_entity": "IL-11"},
      {"server": "stringdb", "tool": "get_interaction_partners", "purpose": "Identify IL-11 interactors", "for_entity": "IL-11"},
      {"server": "kegg", "tool": "get_pathway_info", "purpose": "Get JAK-STAT pathway details", "for_entity": "IL-11/JAK-STAT signaling"}
    ],
    "analysis_tools": [
      {"server": "networkx", "tool": "build_network", "purpose": "Build PPI network from STRING data"},
      {"server": "networkx", "tool": "find_hub_proteins", "purpose": "Identify key hub proteins as drug targets"},
      {"server": "gprofiler", "tool": "enrichment_analysis", "purpose": "Pathway enrichment of network components"},
      {"server": "opentargets", "tool": "assess_druggability", "purpose": "Evaluate druggability of hub proteins"}
    ]
  }
}
```

**Example 3: Drug Discovery**

Requirement: "Screen compounds targeting ACE2-RBD interaction"

Output:
```json
{
  "primary_entities": [
    {
      "type": "protein",
      "name": "ACE2",
      "description": "Host receptor protein",
      "identifiers": {"uniprot": "Q9BYF1"},
      "source": "requirement",
      "priority": "required"
    },
    {
      "type": "domain",
      "name": "RBD",
      "description": "Receptor binding domain (viral spike protein)",
      "identifiers": {},
      "source": "requirement",
      "priority": "required"
    },
    {
      "type": "compound",
      "name": "screening library",
      "description": "Compounds to screen against ACE2-RBD",
      "identifiers": {},
      "source": "requirement",
      "priority": "required"
    }
  ],
  "data_requirements": [
    {
      "type": "structure",
      "source": "pdb",
      "priority": "required",
      "reason": "Need ACE2-RBD complex structure for docking"
    },
    {
      "type": "compound",
      "source": "chembl",
      "priority": "required",
      "reason": "ChEMBL compounds with known bioactivity for screening"
    }
  ],
  "analysis_needs": ["docking", "binding_affinity", "druggability"],
  "context_refinements": {},
  "tool_guidance": {
    "collection_tools": [
      {"server": "rcsbpdb", "tool": "download_pdb", "purpose": "Get ACE2-RBD complex structure", "for_entity": "ACE2"},
      {"server": "rcsbpdb", "tool": "get_binding_sites", "purpose": "Identify binding site for docking", "for_entity": "ACE2"},
      {"server": "chembl", "tool": "get_target_bioactivities", "purpose": "Get known active compounds", "for_entity": "ACE2"}
    ],
    "analysis_tools": [
      {"server": "vina", "tool": "dock_ligand", "purpose": "Dock compounds to ACE2-RBD interface"},
      {"server": "vina", "tool": "calculate_binding_affinity", "purpose": "Rank compounds by affinity"},
      {"server": "opentargets", "tool": "search_target_drugs", "purpose": "Find existing drugs targeting ACE2"}
    ]
  }
}
```

================================================================================
INSTRUCTIONS
================================================================================

1. **Read the requirement carefully** - identify all entities, expected deliverables
2. **Extract context refinements** - look for specific values in context deliverables
3. **Classify entities** - use the entity type reference table
4. **Determine data needs** - based on entities and deliverables
5. **Identify analyses** - based on requirement type (design, analysis, screening, etc.)
6. **Return strict JSON** - must be valid, parseable JSON

**CRITICAL**:
- Focus on the **requirement description** as primary source
- Use **context deliverables** to refine entities (e.g., narrow protein → domain)
- Use **research_goal** only as fallback if requirement is unclear
- All JSON keys must be exactly as shown in the schema
- All entity types must be from the reference table

Now analyze the requirement above and return your entity analysis as JSON.
