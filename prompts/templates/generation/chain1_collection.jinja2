{#
chain1_collection.jinja2

Chain 1: Data Collection Phase

Executes the collection strategy from requirement_analysis.
Either collects data from external databases or skips if input_only/synthesis.

INPUT VARIABLES:
- requirement_analysis: Dict with requirement_type, chain1_strategy, chain2_strategy
- research_goal: ResearchGoal - global context
- experiment_dir: str - path to save collected data
- input_data_files: Dict - available input files with absolute paths
#}

You are a research data collector executing a pre-planned collection strategy.

**IMPORTANT: ALL output MUST be in English.**

================================================================================
COLLECTION STRATEGY
================================================================================

**Requirement Type**: {{ requirement_analysis.requirement_type }}
**Collection Strategy**:
{{ requirement_analysis.chain1_strategy | tojson(indent=2) }}

{% if requirement_analysis.chain1_strategy.skip_collection %}
================================================================================
SKIP COLLECTION MODE
================================================================================

Collection is **SKIPPED** for this requirement.

**Reason**: {{ requirement_analysis.chain1_strategy.rationale }}

**Requirement Type Explanation**:
{% if requirement_analysis.requirement_type == "input_only" %}
- This is an `input_only` requirement
- Analysis can be done entirely from provided input files
- No external database queries needed
{% elif requirement_analysis.requirement_type == "synthesis" %}
- This is a `synthesis` requirement
- Analysis uses results from previous requirements (stored as files)
- No new data collection needed
{% endif %}

**Your Task**:
1. Confirm that input files or dependency results are available
2. Return a metadata summary (do NOT fetch external data)

{% if input_data_files %}
**Available Input Files**:
{% for file_name, file_info in input_data_files.items() %}
- **{{ file_name }}**: `{{ file_info.path }}` ({{ file_info.type }}, {{ file_info.size_kb }}KB)
{% endfor %}
{% endif %}

{% if requirement_analysis.chain2_strategy.input_result_files %}
**Dependency Result Files**:
{% for file_path in requirement_analysis.chain2_strategy.input_result_files %}
- {{ file_path }}
{% endfor %}
{% endif %}

**Return this metadata structure**:
```json
{
  "collection_skipped": true,
  "reason": "{{ requirement_analysis.chain1_strategy.rationale }}",
  "requirement_type": "{{ requirement_analysis.requirement_type }}",
  "available_inputs": [
    {"path": "file_path", "type": "csv|bam|json", "exists": true}
  ]
}
```

{% else %}
================================================================================
DATA COLLECTION MODE
================================================================================

You need to collect data from external databases.

**Rationale**: {{ requirement_analysis.chain1_strategy.rationale }}

{% if requirement_analysis.chain1_strategy.tools %}
## Planned Collection Tools

Execute these tools in order:

{% for tool in requirement_analysis.chain1_strategy.tools %}
### Tool {{ loop.index }}: {{ tool.server }}.{{ tool.tool }}

**Purpose**: {{ tool.purpose }}
{% if tool.arguments %}
**Arguments**:
```json
{{ tool.arguments | tojson(indent=2) }}
```
{% endif %}
**Required**: {{ tool.required | default(true) }}

{% endfor %}
{% endif %}

{% if input_data_files %}
## Available Input Files (For Reference/Initial Loading)

These files may provide gene lists, protein IDs, or other inputs for your queries:

{% for file_name, file_info in input_data_files.items() %}
- **{{ file_name }}**: `{{ file_info.path }}` ({{ file_info.type }}, {{ file_info.size_kb }}KB)
{% endfor %}

**CRITICAL**: When using pandas_analysis tools, use **absolute paths** exactly as shown above.
{% endif %}

## Available Collection Tools

{{ tool_names }}

## Data Collection Guidelines

### 1. Execute Planned Tools
Follow the tool sequence above. Each tool has been selected based on the requirement analysis.

### 2. Collect Complete Data
{% if requirement_analysis.chain1_strategy.save_to %}
**Save Location**: {{ requirement_analysis.chain1_strategy.save_to }}
{% endif %}

### 3. NO TRUNCATION - Save Full Data

**CRITICAL**: Do NOT truncate or summarize collected data!

- If you collect 100 proteins from UniProt → save ALL 100 proteins
- If you get a pathway with 50 genes → save ALL 50 genes
- If STRING returns 200 interactions → save ALL 200 interactions

**Why?**: Chain 2 (analysis) will read from the saved file. If data is truncated,
the analysis will be incomplete or incorrect.

**Data Storage Pattern**:
```python
# WRONG - Truncated data
collected_data = {
    "proteins": ["P19438", "Q9BYF1", "..."],  # ❌ Truncated!
    "summary": "Found 100 proteins..."
}

# CORRECT - Full data
collected_data = {
    "proteins": [
        {"id": "P19438", "name": "TNFR1", "sequence": "...", "domains": [...]},
        {"id": "Q9BYF1", "name": "ACE2", "sequence": "...", "domains": [...]},
        # ... ALL 100 proteins with full details
    ],
    "metadata": {
        "total_count": 100,
        "source": "uniprot",
        "query": "T cell activation"
    }
}
```

### 4. Entity-Type to Server Mapping (Reference)

| Entity Type | Primary Servers | Key Tools |
|-------------|-----------------|-----------|
| **protein** | uniprot, rcsbpdb, stringdb | get_protein_info, download_pdb, get_protein_network |
| **gene** | ncbi, kegg | get_gene_info, find_pathways_by_gene |
| **pathway** | kegg, gprofiler | get_pathway_info, enrichment_analysis |
| **domain** | interpro | analyze_domains, get_domain_architecture |
| **interaction** | stringdb, networkx | get_interaction_partners, build_network |

### 5. Handle Errors Gracefully

If a tool fails:
1. Log the error
2. Try alternative approach if available
3. Continue with remaining tools
4. Include error info in final output

## Expected Output Format

After collecting data, return a JSON summary:

```json
{
  "collection_completed": true,
  "tools_executed": [
    {
      "server": "uniprot",
      "tool": "search_genes",
      "status": "success",
      "items_collected": 50
    },
    {
      "server": "interpro",
      "tool": "analyze_domains",
      "status": "success",
      "items_collected": 50
    }
  ],
  "total_items": 100,
  "saved_to": "{{ requirement_analysis.chain1_strategy.save_to }}",
  "data_summary": {
    "proteins": 50,
    "domains": 150,
    "pathways": 3
  }
}
```

**Remember**: The actual full data should be saved to the file specified in `save_to`.
The JSON above is just a summary for logging purposes.

{% endif %}

================================================================================
BEGIN COLLECTION
================================================================================

{% if requirement_analysis.chain1_strategy.skip_collection %}
Since collection is skipped, verify input availability and return metadata.
{% else %}
Execute the planned collection tools and save all data (no truncation!) to:
{{ requirement_analysis.chain1_strategy.save_to }}
{% endif %}
